# [Day 7] BIBLE 기준 코드 품질 개선 및 유지보수 시작

## 📅 기본 정보
- **날짜**: 2026-02-04 (수요일)
- **개발 일차**: 7일차
- **작업 카테고리**: 매치엔진

## 🛠️ 오늘의 구현 (Implementation)
> 오늘 작업한 핵심 기능과 로직을 기술합니다.
- [x] **공 방향 급변 버그 수정 v2**: 
  - `RotateCharacter()`에서 Turn Assist 공 끌어당기기 제거 (충돌 원인)
  - Lateral damping 임계값: 0.1f → 1.0f (불필요한 힘 감소)
  - Lateral damping 강도: 4.0f → 2.0f
- [x] **중앙 집중식 공 물리 관리 시스템**: 
  - 새 `BallForceAccumulator.cs` 컴포넌트 생성
  - 모든 에이전트의 공 AddForce → RequestForce로 변경
  - FixedUpdate 마지막에 합산된 힘 한 번에 적용
- [x] **드리블 반응성 개선**:
  - `DribbleAssist()`의 공 당김 힘(Spring Force) 2.5배 증가 (12.0f → 30.0f)
  - `RotationCharacter()`의 사선 바라보기 로직 제거 (이동 방향 주시)
- [x] **드리블 충돌 개선**:
  - `DribbleAssist()` Sweet Spot 거리 증가 (정지: 0.6m → 0.8m, 이동: 0.85m → 0.95m). 콜라이더(0.5m) + 공(0.1m) 겹침 방지.
- [x] **드리블 곡선 이동 (Orbit Physics)**:
  - 공이 선수 정면 5도(기존 45도) 밖에 있을 때, 직진 당기기 대신 **회전(Tangential) 힘** 적용.
  - 정면에서도 충돌 없이 공이 선수 주변을 돌아 Sweet Spot으로 이동하도록 개선.
- [x] **패스/슈팅 중복 적용 방지**:
  - `ExecuteKickPhysics()`에 공과의 거리 체크(1.5m) 추가. 공이 이미 떠났으면 킥 취소(Phantom Kick 방지).
  - 킥 실행 시 `ClearPendingForces()`로 누적된 힘 초기화 (이미 적용됨).
- *기술적 메모*: `toBall` 변수 중복 선언(CS0128) 수정 (`toBallFlat`으로 변경).
- [x] **공 빨아들임(Vacuum) 방지 & 턴 유지 (Hysteresis)**:
  - `DribbleAssist()` 진입(Entry) 조건: 거리 < 1.1m (가까워야 힘 발동).
  - `DribbleAssist()` 유지(Exit) 조건: 거리 > 1.7m (턴 할 때 멀어져도 힘 유지).
  - 패스 가로채기 방지: 진입 시 공 속도 > 15m/s면 무시.
- [x] **드리블 물리력 종합 튜닝 (Orbit 충돌 해결)**:
  - **회전 힘(Orbit Force)**: 12.0f → **30.0f** (복구, 빠른 회전).
  - **전진 당김 추가**: 공이 뒤에 있을수록 앞으로도 당기는 힘 추가 (`forwardPull`).
  - **구심력 비대칭화**: 밀기(Push) **50.0f**, 당기기(Pull) **15.0f** (직선 당김 방지).
  - **Velocity Matching / Lateral Clamp**: 공이 정면(angle <= 5)일 때만 작동 (Orbit 방해 방지).
- [x] **드리블 로직 전면 개편 (Unified Velocity PID)**:
  - 기존: 복잡한 Orbit/Spring/Radial 힘 조합 (튜닝 어려움, 충돌 발생).
  - 변경: **목표 속도(Target Velocity)** 기반 PID 제어 도입.
  - `IdealBallVelocity = AgentVelocity + CorrectionVector`.
  - 턴 동작 시 자연스럽게 위치 보정 벡터가 커지며 공을 당겨옴.
  - 뒤/옆에 있을 때 보정 게인 증가 (2.0 -> 10.0)로 빠른 반응성 확보.
- [x] **킥오프/정지 상태 안정화**:
  - 킥오프 시 `ResetDribbleState()`로 이전 드리블 힘 제거.
  - 정지 상태: Damping(-5.0f)으로 공 굴러감 방지 및 안정적 유지.
- [x] **Trap & Turn 메커니즘 ("공을 보고 돌아라")**:
  - 기존: 공이 뒤에 있어도 마법처럼 앞으로 당겨옴 (비현실적).
  - 변경: 공이 **행동 가능 각도(30도)** 범위를 벗어나면 드리블 중단 (User Request).
  - **Trap**: 이동을 멈추고 공에 제동을 걸어 멈춰 세움.
  - **Turn**: 공을 향해 몸을 빠르게 회전 (720도/초).
  - **Resume**: 공이 30도 내로 들어오면 다시 전진하며 드리블 재개.
- [x] **AI 행동 판단 각도/거리 제한 (Action Block)**:
  - 문제: 공이 뒤에 있거나 멀리 있는데도 "Pass" 로그가 찍히고 행동 시도함.
  - 해결: `CanKick()`에 **30도 각도 체크** 및 **1.2m 거리 체크** 추가.
  - 효과:
    - 거리 벗어남 -> **전진 드리블/접근** 유도.
- [x] **회전 행동 로그 출력**:
  - Trap & Turn 발동 시 화면 좌측 상단 로그창에 `"{Name}: Turn to Ball"` 출력.
  - 패스/슈팅과 동일하게 선수의 판단을 시각적으로 확인 가능.
- [x] **회전 로직 버그 수정**:
  - 문제: 로그는 찍히지만 선수가 실제로 회전하지 않음 (`RotateCharacter`가 덮어씀).
  - 해결: `RotateCharacter` 최상단에 `_isRecoveringBall` 상태일 경우 **강제 회전(720도/초)** 로직 추가.
  - 추가 수정: `rb.rotation` 대신 **`rb.MoveRotation`** 사용 및 `angularVelocity` 초기화로 물리 간섭 제거.
  - 추가 수정: 회전 속도를 3600도/초 (Instant Snap)로 대폭 상향하여 "한 번에 휙 도는" 느낌 구현 (User Req).
  - **재수정 (User Feedback)**:
    - 회전 속도가 너무 빠르고 공을 두고 돔 -> **360도/초**로 하향 조정.
    - 회전 시 공을 발 밑(0.5m 앞)으로 당기는 **Spring+Damping Force** 추가 (Trap & Pull).
    - 결과: 선수가 돌 때 공도 발에 붙어서 같이 회전함.
  - **로그 반복(진동) 해결**:
    - 문제: 30도 경계에서 상태가 계속 오락가락하며 "Turn to Ball" 로그가 무한 반복됨.
    - 해결: **Hysteresis(히스테리시스) 적용**. 진입은 30도에서 하되, 탈출은 **15도(완전 정렬)**가 되어야 하도록 수정.
- [x] **시각적 디버깅 도구 (Visual Debugger) 추가**:
  - Unity Scene View에 AI의 판단을 시각화.
  - **30도 Cone**: 노란색 (비활성) / 초록색 (활성).
  - **Ball Line**: 거리 1.2m 이내면 초록, 밖이면 빨강.
  - **Status Text**: AI 머리 위에 "TRAP & TURN" / "DRIBBLE" 및 실시간 각도/거리 표시.
  - 효과: 로그 파일 없이 화면만으로 AI의 의도와 물리적 상황 파악 가능.
- [x] **돌파(Breakthrough) 스킬 미발동 수정**:
  - 원인: 스킬 로직은 있었으나 AI 두뇌(`RootState_Attacking`)에서 호출하는 코드가 누락됨.
  - 해결: **전방이 막혔을 때(`IsFrontalBlocked`)**, 패스보다 우선하여 **돌파 스킬**을 시도하도록 로직 연결.
  - 효과: 적이 앞을 막으면 `BREAKTHROUGH!` 로그와 함께 상대를 밀쳐내고 전진함.
- [x] **행동 가능 거리 확장**:
  - `CanKick` 거리를 1.2m -> 2.0m로 완화 (User Req: 너무 짧아서 반응 안 함)
  - `angleToBall` 계산 시 Y축(높이) 영향으로 부정확했던 문제를 `toBall.y = 0`으로 해결.
  - UI 로그 외에 `Debug.Log` 추가하여 콘솔에서도 확인 가능하도록 조치.
- [x] **회전 동기화 (Orbit Lock) 구현**:
  - 기존 문제: 몸은 도는데 공이 물리 법칙 때문에 제자리에 남거나 늦게 따라옴.
  - 해결: `RotateCharacter`에서 **회전량(Delta)** 을 계산하여, 공의 위치도 똑같은 각도만큼 강제로 회전시킴 (Orbit Lock).
  - 효과: 공이 발에 붙어서 몸과 1:1로 동기화되어 회전함. (User Req: "공이 따라와야 한다")
  - **추가 보완**:
    - **최소 반경 보정**: 공이 너무 가까우면(0.5m 미만) 회전 시 0.5m 지점으로 밀어내면서 돔 (끼임 방지).
    - **제동력 강화**: Trap 모드 진입 시 브레이크 힘 2배 강화 (10 -> 20)로 즉각 정지.
    - **Orbit 강도 강화**: 공을 돌리는 힘 4배 강화 (5 -> 20)로 딜레이 없이 똭! 붙음.
- [x] **직관적 시각화 (Color Coding) 적용**:
  - "문제가 직관적으로 안 보인다"는 피드백 반영.
  - Scene View가 아닌 **Game View**에서도 바로 상태를 알 수 있도록 플레이어 색상 변경 기능 추가.
  - **Color Fix**: 메쉬(SkinnedMeshRenderer)를 찾지 못해 색상이 안 바뀌던 문제 수정.
  - **노란색**: Trap & Turn (회전 중 / Hysteresis 상태).
  - **빨간색**: 돌파 스킬 발동 중 (충돌/밀치기).
  - **초록색**: 킥/패스 준비 중 (차기 직전).
  - **하늘색**: 정밀 조준 중.
  - 효과: 플레이어가 노란색으로 깜빡이면 회전 문제가 있는 것. 빨간색이면 돌파 중인 것. 상태 파악이 즉관적임.
- [x] **게임 멈춤(AI 정지) 현상 수정**:
  - 증상: 플레이어들이 드리블 상태에서 전원 멈춰있는 현상 발생 (로그: `Missed Kick!`).
  - 원인: 공 소유 범위(1.75m)와 킥 가능 범위(1.5m) 사이의 **데드존(Dead Zone)**.
    - 공이 1.72m에 있을 때, AI는 소유권이 있어 이동을 멈추지만(`ResetPath`), 킥은 범위 밖이라 실패함. 이것이 무한 반복됨.
  - 해결: 킥 실패(`Missed Kick`) 시 **강제로 소유권을 포기(`ClearBallOwner`)** 하도록 수정.
  - 효과: 소유권을 잃은 AI가 즉시 "추적(Chase)" 모드로 전환되어 공에 다가감 -> 거리 좁혀서 다시 킥 성공.
- [x] **공 소유 중 AI 정지 (Logic Freeze) 수정**:
  - 증상: 공을 가지고 있는데(`Turn to Ball` 로그) 아무것도 안하고 멍하니 서 있음.
  - 원인: `MoveCharacter`의 Recovery(Trap) 탈출 조건이 `거리 < 1.0m`였음.
    - 공이 1.48m에 있으면, Trap 모드라 움직임을 멈추지만(`ResetPath`),
  - [x] 원인: Trap 모드 탈출 조건(`거리 < 1.0m`) 때문에 1.48m에서 갇힘.
  - [x] 해결: **거리 조건 삭제**. 공을 바라보기만 하면(`angle < 15`) 바로 Trap 모드를 탈출하고 이동 재개.
- [x] **Trap & Turn 무한 반복(Oscillation) 수정**:
  - 증상: Trap(노랑)과 Dribble(흰색) 상태가 0.1초 단위로 번갈아가며 나타남 (덜덜거림).
  - 원인: Trap 탈출 후 이동 시 방향 전환 -> 공이 뒤처짐 -> 각도 30도 초과 -> 다시 Trap 진입 -> 각도 정렬 -> 탈출 -> 반복.
  - 해결: **히스테리시스 타이머(Hysteresis Timer)** 도입.
    - Trap 모드를 탈출한 직후 0.5초 동안은 진입 임계값을 30도 -> **50도**로 완화.
    - 회전을 시작할 때 즉시 Trap이 다시 켜지는 것을 방지하여 부드러운 전환 구현.

- *기술적 메모*: 여러 에이전트가 순차적으로 AddForce 호출 시 힘 상충 발생. Force Accumulator 패턴으로 모든 힘을 수집 후 합산 적용. 킥/슈팅 실행 시 `ClearPendingForces()`로 드리블 힘 제거.

## 🎥 영상 소스 & 연출 (For YouTube)
> 1분 내외의 개발 로그 영상에 들어갈 시각적 요소를 기록합니다.
1. **메인 샷**: 
2. **버그/개그 샷**: 
3. **강조할 점**: 

## 🐛 이슈 및 버그 (Issues)
- **해결됨**: 
- **진행 중**: 

## 자동 완성 가이드 (Auto-Fill Guide)
*만약 사용자가 내용을 비워둘 경우, 기존 문서를 참고하여 다음 내용을 제안(Suggestion)할 수 있습니다.*

* **물리 공식 참조**: `3D_축구_매치_엔진_개발_문서화.md`의 $P_{Goal}$, $P_{Pass}$, 마그누스 효과 공식.
* **능력치 참조**: `선수-테이블.md`의 변수명 (예: `Stat_Strength`, `Stat_Tech`).
* **역할 참조**: `라이센스-단계-전술-지침.md`의 포지션 역할 (예: 인버티드 윙백, 하프백).
